{% include "header.html" %}

<h2>Detalhes do Chamado</h2>

<p><strong>Cliente:</strong> {{ chamado.cliente.username }} ({{ chamado.cliente.matricula }}) - {{ chamado.cliente.email }}</p>

{% if chamado.tecnico %}
    <p><strong>Técnico:</strong> {{ chamado.tecnico.username }} ({{ chamado.tecnico.matricula }}) - {{ chamado.tecnico.email }}</p>
{% endif %}

<p><strong>Título:</strong> {{ chamado.titulo }}</p>
<p><strong>Categoria:</strong> {{ chamado.get_categoria_display }}</p>
<p><strong>Prioridade:</strong> {{ chamado.get_prioridade_display }}</p>
<p><strong>Status:</strong> {{ chamado.get_status_display }}</p>
<p><strong>Descrição:</strong> {{ chamado.descricao }}</p>

{% if chamado.anexo_cliente %}
    <p><strong>Anexo do Cliente:</strong> <a href="{{ chamado.anexo_cliente.url }}" download>Baixar</a></p>
{% endif %}
{% if chamado.anexo_tecnico %}
    <p><strong>Anexo do Técnico:</strong> <a href="{{ chamado.anexo_tecnico.url }}" download>Baixar</a></p>
{% endif %}
{% if chamado.solucao %}
    <p><strong>Solução do Técnico:</strong> {{ chamado.solucao }}</p>
{% endif %}

{% if is_cliente %}
    {% if chamado.status == 'aberto' or chamado.status == 'em_atendimento' %}
        <a href="{% url 'editar_chamado' chamado.id_protocolo %}">
            <button type="button">Editar Chamado</button>
        </a>
        <form method="post" action="{% url 'fechar_chamado' chamado.id_protocolo %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Fechar Chamado</button>
        </form>
        {% if chamado.status == 'em_atendimento' %}
            <p>Seu chamado está sendo atendido por {{ chamado.tecnico.username }}.</p>
        {% endif %}
    {% elif chamado.status == 'fechado' %}
        <form method="post" action="{% url 'reabrir_chamado' chamado.id_protocolo %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Reabrir Chamado</button>
        </form>
        <form method="post" action="{% url 'deletar_chamado' chamado.id_protocolo %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" onclick="return confirm('Tem certeza que deseja excluir este chamado?');">Excluir Chamado</button>
        </form>
    {% endif %}
{% endif %}

{% if is_tecnico %}
    {% if chamado.status == 'aberto' %}
        <form method="post" action="{% url 'aceitar_chamado' chamado.id_protocolo %}">
            {% csrf_token %}
            <button type="submit">Aceitar Chamado</button>
        </form>
    {% elif chamado.status == 'em_atendimento' and chamado.tecnico == user %}
        <a href="{% url 'editar_chamado' chamado.id_protocolo %}">
            <button type="button">Editar Dados Técnicos</button>
        </a>
        <a href="{% url 'editar_solucao' chamado.id_protocolo %}">
            <button type="button">Editar Solução</button>
        </a>
        <form method="post" action="{% url 'fechar_chamado' chamado.id_protocolo %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Fechar Chamado</button>
        </form>
        <form method="post" action="{% url 'cancelar_chamado' chamado.id_protocolo %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Cancelar Atendimento</button>
        </form>
    {% elif chamado.status == 'em_atendimento' and chamado.tecnico != user %}
        <p><em>Este chamado está em atendimento por outro técnico.</em></p>
    {% endif %}
{% endif %}

<a href="{% url 'dashboard' %}">
    <button type="button">Voltar para Início</button>
</a>